rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPERS
    // ============================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function userExists(uid) {
      return exists(/databases/$(database)/documents/users/$(uid));
    }

    function isEmailVerified() {
      return isSignedIn() &&
        userExists(request.auth.uid) &&
        userDoc(request.auth.uid).data.emailVerified == true;
    }

    function isAdmin() {
      return isSignedIn() &&
        userExists(request.auth.uid) &&
        userDoc(request.auth.uid).data.role == 'admin';
    }

    function getUserData() {
      return userDoc(request.auth.uid).data;
    }

    // ============================================================================
    // RATE LIMIT HELPERS
    // ============================================================================

    function canPost() {
      let u = getUserData();
      return !('lastPostTime' in u) ||
        u.lastPostTime == null ||
        u.lastPostTime < request.time - duration.value(30, 's');
    }

    function canComment() {
      let u = getUserData();
      return !('lastCommentTime' in u) ||
        u.lastCommentTime == null ||
        u.lastCommentTime < request.time - duration.value(5, 's');
    }

    function canMessage() {
      let u = getUserData();
      return !('lastMessageTime' in u) ||
        u.lastMessageTime == null ||
        u.lastMessageTime < request.time - duration.value(0.2, 's');
    }

    function canScore() {
      let u = getUserData();
      return !('lastScoreTime' in u) ||
        u.lastScoreTime == null ||
        u.lastScoreTime < request.time - duration.value(60, 's');
    }

    // ============================================================================
    // USERS
    // ============================================================================

    match /users/{userId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;

      allow update: if isSignedIn() &&
        (
          request.auth.uid == userId ||
          isAdmin() ||
          request.resource.data.diff(resource.data)
            .affectedKeys().hasOnly(['partners'])
        );

      allow delete: if isAdmin();
    }

    // ============================================================================
    // THOUGHTS (CLUBHOUSE POSTS)
    // ============================================================================

    match /thoughts/{thoughtId} {
      allow read, list: if true;

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        canPost() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.content.size() <= 280;

      // ✅ FIXED: Allow owner/admin full update, OR any signed-in user can update engagement fields
      allow update: if isSignedIn() &&
        (
          request.auth.uid == resource.data.userId ||
          isAdmin() ||
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['likes', 'likedBy', 'comments', 'lastActivityAt', 'engagementScore', 'viewCount'])
        );

      allow delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());

      // COMMENTS SUBCOLLECTION
      match /comments/{commentId} {
        allow read, list: if true;
        allow create, update, delete: if isSignedIn();
      }
    }  
    // ============================================================================
    // COMMENTS (TOP-LEVEL - FOR CLOUD FUNCTION TRIGGERS)
    // ============================================================================

    match /comments/{commentId} {
      allow read, list: if isSignedIn();

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.content.size() <= 500 &&
        request.resource.data.postId is string &&
        request.resource.data.postAuthorId is string;

      // ✅ FIXED: Allow engagement field updates for comment likes
      allow update: if isSignedIn() &&
        (
          request.auth.uid == resource.data.userId ||
          isAdmin() ||
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['likes', 'likedBy'])
        );

      allow delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ============================================================================
    // LIKES (POST LIKES)
    // ============================================================================

    match /likes/{likeId} {
      allow read, list: if isSignedIn();

      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.postId is string &&
        request.resource.data.postAuthorId is string;

      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.userId;

      allow update: if false;
    }

    // ============================================================================
    // COMMENT LIKES (FOR CLOUD FUNCTION TRIGGERS)
    // ============================================================================

    match /comment_likes/{likeId} {
      allow read, list: if isSignedIn();

      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.commentId is string &&
        request.resource.data.commentAuthorId is string;

      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.userId;

      allow update: if false;
    }

    // ============================================================================
    // SHARES (FOR CLOUD FUNCTION TRIGGERS - FUTURE)
    // ============================================================================

    match /shares/{shareId} {
      allow read, list: if isSignedIn();

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.userId == request.auth.uid;

      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.userId;

      allow update: if false;
    }

    // ============================================================================
    // SCORES
    // ============================================================================

    match /scores/{scoreId} {
      allow read, list: if true;

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        canScore() &&
        request.resource.data.userId == request.auth.uid;

      allow update, delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ============================================================================
    // LEADERBOARDS
    // ============================================================================

    match /leaderboards/{leaderboardId} {
      allow read, list: if true;
      allow create, update: if isSignedIn();
      allow delete: if isAdmin();
    }

    // ============================================================================
    // TOURNAMENTS (PGA TOUR DATA)
    // ============================================================================

    match /tournaments/{tournamentId} {
      // Anyone can read tournament data (public info)
      allow read, list: if true;
      
      // Only Cloud Functions can write (via Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================================================
    // TOURNAMENT CHATS (LIVE CHAT DURING TOURNAMENTS)
    // ============================================================================

    // Pattern: tournamentChats_2026_006_live or tournamentChats_2026_006_onpremise
    match /{chatCollection}/{messageId} {
      // Only match tournament chat collections
      allow read, list: if isSignedIn() && 
        chatCollection.matches('tournamentChats_.*');

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        chatCollection.matches('tournamentChats_.*') &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.content.size() <= 280;

      // Allow users to delete their own messages, admins can delete any
      allow delete: if isSignedIn() &&
        chatCollection.matches('tournamentChats_.*') &&
        (request.auth.uid == resource.data.userId || isAdmin());

      // No updates to chat messages
      allow update: if false;
    }

    // ============================================================================
    // COURSES / CLUBS
    // ============================================================================

    match /courses/{courseId} {
      allow read, list: if true;
      allow create, update: if isSignedIn();
      allow delete: if isAdmin();
    }

    match /clubs/{clubId} {
      allow read, list: if true;

      allow create: if isSignedIn() && isEmailVerified();

      allow update, delete: if isSignedIn() &&
        (request.auth.uid == resource.data.ownerId || isAdmin());
    }

    // ============================================================================
    // PARTNER REQUESTS
    // ============================================================================

    match /partnerRequests/{requestId} {
      allow read, list: if isSignedIn() &&
        (
          request.auth.uid == resource.data.fromUserId ||
          request.auth.uid == resource.data.toUserId ||
          isAdmin()
        );

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.fromUserId == request.auth.uid;

      allow update, delete: if isSignedIn() &&
        (
          request.auth.uid == resource.data.fromUserId ||
          request.auth.uid == resource.data.toUserId ||
          isAdmin()
        );
    }

    // ============================================================================
    // PARTNERS
    // ============================================================================

    match /partners/{partnerId} {
      allow read, list: if isSignedIn() &&
        (
          request.auth.uid == resource.data.user1Id ||
          request.auth.uid == resource.data.user2Id ||
          isAdmin()
        );

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        (
          request.auth.uid == request.resource.data.user1Id ||
          request.auth.uid == request.resource.data.user2Id
        );

      allow update, delete: if isSignedIn() &&
        (
          request.auth.uid == resource.data.user1Id ||
          request.auth.uid == resource.data.user2Id ||
          isAdmin()
        );
    }

    // ============================================================================
    // NOTIFICATIONS
    // ============================================================================

    match /notifications/{notificationId} {
      allow read, list: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());

      allow create: if isAdmin();

      allow update, delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ============================================================================
    // THREADS (MESSAGING)
    // ============================================================================

    match /threads/{threadId} {

      function isUserInThreadId() {
        return request.auth != null &&
          threadId.matches('.*' + request.auth.uid + '.*');
      }

      function isParticipant() {
        return request.auth != null &&
          resource.data.participants.hasAny([request.auth.uid]);
      }

      allow list: if isSignedIn();

      allow read: if isSignedIn() && 
        (isParticipant() || isUserInThreadId());

      allow create: if isSignedIn() &&
        isUserInThreadId() &&
        request.resource.data.participants is list &&
        request.resource.data.participants.hasAny([request.auth.uid]);

      allow delete: if isAdmin() || isParticipant();

      allow update: if isSignedIn() &&
        isParticipant() &&
        request.resource.data.participants == resource.data.participants &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'lastMessage',
          'lastSenderId',
          'lastMessageAt',
          'unreadCount',
          'participantNames',
          'participantAvatars',
          'updatedAt',
          'archivedBy',
          'deletedBy'
        ]) &&
        (
          !('unreadCount' in request.resource.data) ||
          isAdmin() ||
          request.resource.data.unreadCount
            .diff(resource.data.unreadCount)
            .affectedKeys().hasOnly([request.auth.uid])
        );

      // THREAD MESSAGES
      match /messages/{messageId} {

        function isUserInParentThreadId() {
          return request.auth != null &&
            threadId.matches('.*' + request.auth.uid + '.*');
        }

        allow list: if isSignedIn() && isUserInParentThreadId();

        allow read: if request.auth != null &&
          (resource.data.senderId == request.auth.uid ||
           resource.data.receiverId == request.auth.uid ||
           isUserInParentThreadId());

        allow create: if isSignedIn() &&
          isEmailVerified() &&
          canMessage() &&
          isUserInParentThreadId() &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.content.size() <= 1000;

        allow update: if isSignedIn() &&
          (
            (request.auth.uid == resource.data.receiverId &&
             request.resource.data.diff(resource.data)
               .affectedKeys().hasOnly(['read', 'readAt']))
            ||
            (request.auth.uid == resource.data.senderId &&
             request.resource.data.diff(resource.data)
               .affectedKeys().hasOnly(['content', 'edited', 'editedAt']))
          );

        allow delete: if isSignedIn() &&
          (request.auth.uid == resource.data.senderId || isAdmin());
      }
    }

    // ============================================================================
    // MESSAGES (TOP-LEVEL - FOR CLOUD FUNCTION TRIGGERS)
    // ============================================================================

    match /messages/{messageId} {
      allow read, list: if isSignedIn() &&
        (
          request.auth.uid == resource.data.senderId ||
          request.auth.uid == resource.data.receiverId ||
          isAdmin()
        );

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.senderId == request.auth.uid;

      allow update, delete: if isSignedIn() &&
        (request.auth.uid == resource.data.senderId || isAdmin());
    }

    // ============================================================================
    // HOLE-IN-ONE VERIFICATION
    // ============================================================================

    match /hole_in_ones/{holeInOneId} {
      allow read, list: if isSignedIn() &&
        (
          request.auth.uid == resource.data.userId ||
          request.auth.uid == resource.data.verifierId ||
          isAdmin()
        );

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isSignedIn() &&
        (
          request.auth.uid == resource.data.userId ||
          request.auth.uid == resource.data.verifierId ||
          isAdmin()
        );

      allow delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ============================================================================
    // COURSE MEMBERSHIPS
    // ============================================================================

    match /course_memberships/{membershipId} {
      allow read, list: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isAdmin();

      allow delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ============================================================================
    // VERIFICATION REQUESTS (PGA/COURSE)
    // ============================================================================

    match /verification_requests/{requestId} {
      allow read, list: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());

      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isAdmin();

      allow delete: if isAdmin();
    }

    // ============================================================================
    // COURSE LEADERS
    // ============================================================================

    match /course_leaders/{courseId} {
      allow read, list: if true;
      
      allow create, update: if isSignedIn() && isEmailVerified();
      
      allow delete: if isAdmin();
    }

    // ============================================================================
    // REPORTS
    // ============================================================================

    match /reports/{reportId} {
      allow read, list: if isAdmin();

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.reporterId == request.auth.uid;

      allow update, delete: if isAdmin();
    }

    // ============================================================================
    // PUSH TOKENS
    // ============================================================================

    match /push_tokens/{tokenId} {
      allow read, list: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());

      allow create, update: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      allow delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ============================================================================
    // LEAGUES
    // ============================================================================

    match /leagues/{leagueId} {
      allow read, list: if true;

      allow create: if isAdmin();

      allow update: if isSignedIn() &&
        (request.auth.uid == resource.data.hostUserId || isAdmin());

      allow delete: if isAdmin();

      // LEAGUE MEMBERS SUBCOLLECTION
      match /members/{memberId} {
        allow read, list: if isSignedIn();

        allow create: if isSignedIn() &&
          isEmailVerified() &&
          request.resource.data.userId == request.auth.uid;

        allow update: if isSignedIn() &&
          (
            request.auth.uid == resource.data.userId ||
            request.auth.uid == get(/databases/$(database)/documents/leagues/$(leagueId)).data.hostUserId ||
            isAdmin()
          );

        allow delete: if isSignedIn() &&
          (
            request.auth.uid == resource.data.userId ||
            request.auth.uid == get(/databases/$(database)/documents/leagues/$(leagueId)).data.hostUserId ||
            isAdmin()
          );
      }

      // LEAGUE SCORES SUBCOLLECTION
      match /scores/{scoreId} {
        allow read, list: if isSignedIn();

        allow create: if isSignedIn() &&
          isEmailVerified() &&
          request.resource.data.userId == request.auth.uid;

        allow update, delete: if isSignedIn() &&
          (
            request.auth.uid == resource.data.userId ||
            request.auth.uid == get(/databases/$(database)/documents/leagues/$(leagueId)).data.hostUserId ||
            isAdmin()
          );
      }
    }

    // ============================================================================
    // LEAGUE APPLICATIONS
    // ============================================================================

    match /league_applications/{applicationId} {
      allow read, list: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());

      allow create: if isSignedIn() &&
        isEmailVerified() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isAdmin();

      allow delete: if isSignedIn() &&
        (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ============================================================================
    // DEFAULT DENY
    // ============================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}









